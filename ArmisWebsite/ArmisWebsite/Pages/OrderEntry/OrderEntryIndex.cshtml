@page
@model ArmisWebsite.Pages.OrderEntry.OrderEntryIndexModel
@{
    ViewData["Title"] = "OrderEntryIndex";
}

<head>
    <script type="text/javascript" src="~/js/OrderEntry/OrderEntryIndex.js"></script>
</head>
@*Hidden "workbench" to store elements to be used as needed*@
<div style="display:none">
    @*Unit of Measure select*@
    <select id="selectUoMsTOCOPY" style="box-sizing: border-box; width:100%;">
        @foreach (var uom in Model.UoMs)
        {
            <option value="@uom.UoMid">@uom.Label</option>
        }
    </select>
</div>

<div class="container-fluid" style="width: 100%; font-size:14px;">
    @*Main info entry*@
    <div class="card">
        <div class="card-header">
            Enter New Order
        </div>
        <div class="row">
            @*First column*@
            <div class="col-lg-3">
                <div class="row pt-3 pb-1">
                    <div class="col-lg-3 text-right">Customer</div>
                    <div class="col-lg-9">
                        <input id="inputCustomer" list="datalistCustomers" spellcheck="false" type="search" class="form-control" oninput="updateCustomerSelection(this)" />

                        <datalist id="datalistCustomers">
                            @foreach (var customer in Model.Customers)
                            {
                                //Placeholder variable for the option with the bill to info.  It needs to be handled outside of the option tag to handle nulls properly.
                                var optionInnerHtml = (customer.BillTo != null) ? customer.BillTo.Address1 : "";
                                <option data-cust-id="@customer.CustId" value="@customer.CustId. @customer.Name">@optionInnerHtml</option>

                            }
                        </datalist>
                    </div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-3 text-right">Bill To</div>
                    <div class="col-lg-9">
                        <textarea id="textareaBillTo" class="form-control" readonly></textarea>
                    </div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-3 text-right">Ship To</div>
                    <div class="col-lg-9">
                        <input id="inputShipTo" class="form-control" list="datalistShipTo" spellcheck="false" type="search" oninput="udpateShipToTextArea(this)" />
                        <datalist id="datalistShipTo"></datalist>
                        <textarea id="textareaShipTo" class="form-control" disabled></textarea>
                    </div>
                </div>
            </div>

            @*Second column*@
            <div class="col-lg-3">
                <div class="row py-3">
                    <div class="col-lg-3 text-right">PO #</div>
                    <div class="col-lg-9"> <input class="form-control" /> </div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-3 text-right"></div>
                    <div class="col-lg-9"></div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-3 text-right">Contact</div>
                    <div class="col-lg-9">
                        <input id="inputContact" class="form-control" spellcheck="false" type="search" list="datalistContact" />
                        <datalist id="datalistContact">
                        </datalist>
                    </div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-3 text-right">Job/Shipper</div>
                    <div class="col-lg-9"><input class="form-control" /></div>
                </div>
            </div>

            @*Third column*@
            <div class="col-lg-2">
                <div class="row py-1">
                    <div class="col-lg-4 text-right">Quote #</div>
                    <div class="col-lg-8"> <input class="form-control" /> </div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-4 text-right">Expedite</div>
                    <div class="col-lg-8"><select class="form-control"><option selected="selected">Drop Down</option></select></div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-4 text-right">Ship Via</div>
                    <div class="col-lg-8">
                        <select class="form-control">
                            @foreach (var shipVia in Model.ShipViaCodes)
                            {
                                <option>@shipVia.Code</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-4 text-right">Bill Ship</div>
                    <div class="col-lg-8"><select class="form-control"><option selected="selected">Drop Down</option></select></div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-4 text-right">Acct #</div>
                    <div class="col-lg-8"> <input class="form-control" /> </div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-4 text-right">Packaging</div>
                    <div class="col-lg-8">
                        <select class="form-control">
                            @foreach (var packagingCode in Model.PackageCodes)
                            {
                                <option value="@packagingCode.PackageId">@packagingCode.PackageCd</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="row pb-1">
                    <div class="col-lg-4 text-right">Container</div>
                    <div class="col-lg-8">
                        <div class="row">
                            <div class="col-lg-7">
                                Type
                            </div>
                            <div class="col-lg-5">
                                Qty
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-7">
                                <select class="form-control">
                                    @foreach (var container in Model.Containers)
                                    {
                                        <option value="@container.ContainerId">@container.Code</option>
                                    }
                                </select>
                            </div>
                            <div class="col-lg-5">
                                <input class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @*Fourth Column*@
            <div class="col-lg-2">
                <br />
                <br />
                <div class="row py-1">
                    <div class="col-lg-4 text-right">Order Date</div>
                    <div class="col-lg-8"> <input type="date" class="form-control" placeholder="123456789" /> </div>
                </div>
                <div class="row py-1">
                    <div class="col-lg-4 text-right">Req Date</div>
                    <div class="col-lg-8"> <input type="date" class="form-control" placeholder="123456789" /> </div>
                </div>
                <div class="row py-1">
                    <div class="col-lg-4 text-right">Due Date</div>
                    <div class="col-lg-8"> <input type="date" class="form-control" placeholder="123456789" /> </div>
                </div>
                <div class="row py-1">
                    <div class="col-lg-4 text-right">Due Time</div>
                    <div class="col-lg-8"> <input type="time" class="form-control" placeholder="123456789" /> </div>
                </div>
                <br />
                <div class="row pb-1">
                    <div class="col-lg-4 text-right"> ROHS Type</div>
                    <div class="col-lg-8"> <input class="form-control" /> </div>
                </div>
            </div>

            @*Fifth Column*@
            <div class="col-lg-2">
                <br />
                <br />
                <div class="row py-1">
                    <div class="col-lg-1"> <input type="checkbox" class="" /> </div>
                    <div class="col-lg-10">1 - Rework</div>
                </div>
                <div class="row py-1">
                    <div class="col-lg-1"> <input type="checkbox" class="" /> </div>
                    <div class="col-lg-10">2-Print Rec'd</div>
                </div>
                <div class="row py-1">
                    <div class="col-lg-1"> <input type="checkbox" class="" /> </div>
                    <div class="col-lg-10">3-Don't Scan Prints</div>
                </div>
                <div class="row py-1">
                    <div class="col-lg-1"> <input type="checkbox" class="" /> </div>
                    <div class="col-lg-10">4-ROHS Compliant</div>
                </div>
                <div class="row py-1">
                    <div class="col-lg-1"> <input type="checkbox" class="" /> </div>
                    <div class="col-lg-10">5-Strip & Replate</div>
                </div>
                <div class="row py-1">
                    <div class="col-lg-1"> <input type="checkbox" class="" /> </div>
                    <div class="col-lg-10">6-Special Shipping</div>
                </div>
                <div class="row py-1">
                    <div class="col-lg-1"> <input type="checkbox" class="" /> </div>
                    <div class="col-lg-10">7-Production Hold</div>
                </div>
                <div class="row py-1">
                    <div class="col-lg-1"> <input type="checkbox" class="" /> </div>
                    <div class="col-lg-10">8-Return As Is</div>
                </div>
            </div>
        </div>
    </div>

    @*Line items*@
    <div class="card p-2 my-2">
        <div class="row">
            <div class="col-lg-9">
                <div class="row my-1">
                    <div class="col-lg">
                        <h5>Line Items</h5>
                    </div>
                    <div class="col-lg text-right">
                        <div class="row"><div class="col-lg-4">Lot Charge:</div> <div class="col-lg-8"><input class="form-control w-25" /></div></div>
                    </div>
                </div>
                <input id="hdnLineItemsCount" type="number" value="0" step="1" hidden />
                <table class="table table-striped table-bordered" style="table-layout: fixed">
                    <thead>
                        <tr>
                            <th scope="col" style="width:4%">Line</th>
                            <th scope="col" style="width:8%">Qty</th>
                            <th scope="col" style="width:12%">Part #</th>
                            <th scope="col" style="width:4%">Rev</th>
                            <th scope="col" style="width:20%">Description</th>
                            <th scope="col" style="width:8%">PO Price</th>
                            <th scope="col" style="width:8%">U/M</th>
                            <th scope="col" style="width:8%">Piece Weight</th>
                            <th scope="col" style="width:8%">Total</th>
                            <th scope="col" style="width:20%">Part Comments</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyLineItems">
                    </tbody>
                </table>
                <button type="button" class="btn btn-primary float-right" onclick="addLineItem()">Add Line Item</button>
            </div>

            <div class="col-lg-3 border-left">
                <div class="row my-1">
                    <div class="col-lg">
                        <h5>Order Comments</h5>
                    </div>
                    <div class="col-lg">
                        <select class="form-control"><option selected="selected">Add Code</option></select>
                    </div>
                </div>
                <textarea class="form-control h-75">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</textarea>
            </div>
        </div>
    </div>

    @*Process and Cert details*@
    <div class="card p-2">
        <div class="row">
            <div class="col-lg-6">
                <div class="row my-3">
                    <div class="col-lg-2 text-right">
                        <h6>Quality Std:</h6>
                    </div>
                    <div class="col-lg-4">
                        <select class="form-control">
                            @foreach (var qualityStd in Model.QualityStandards)
                            {
                                <option>@qualityStd.QualStdCode</option>
                            }

                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-lg-2 text-right">
                        <h6>Cert:</h6>
                    </div>
                    <div class="col-lg-8">
                        <textarea class="form-control"></textarea>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-lg-2 text-right">
                        <h6>Internal Comments:</h6>
                    </div>
                    <div class="col-lg-8">
                        <textarea class="form-control"></textarea>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="row mb-1">
                    <div class="col-lg-4">
                        <h6>Process</h6>
                        <select class="form-control"><option selected="selected">Zinc Clear</option></select>
                    </div>
                    <div class="col-lg-4">
                        <h6>Alloy</h6>
                        <select class="form-control"><option selected="selected">455 SST</option></select>
                    </div>
                    <div class="col-lg-4">
                        <h6>Base Metal</h6>
                        <select class="form-control"><option selected="selected">Steel</option></select>
                    </div>
                </div>
                <table class="table table-striped table-bordered" style="table-layout:fixed">
                    <thead>
                        <tr>
                            <th scope="col" style="width:7%">Oper</th>
                            <th scope="col" style="width:12%">Desc</th>
                            <th scope="col" style="width:12%">Thickness</th>
                            <th scope="col" style="width:8%">Temp</th>
                            <th scope="col" style="width:16%">Length</th>
                            <th scope="col" style="width:10%">Spec</th>
                            <th scope="col" style="width:8%">Router</th>
                            <th scope="col" style="width:9%">Step #s</th>
                            <th scope="col" style="width:18%">Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">1</th>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                        </tr>
                        <tr>
                            <th scope="row">2</th>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                        </tr>
                        <tr>
                            <th scope="row">3</th>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                        </tr>
                        <tr>
                            <th scope="row">4</th>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                            <td><input style="box-sizing: border-box; width:100%;" /></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg text-right"><button class="btn btn-lg btn-primary p-1 m-3 ">Create Order</button></div>
    </div>
</div>

<script>
    //Globals for the selected customer
    var _shipToModels;
    var _partModels;

    //Datalists do not have a good way of checking which option was selected.  Datalist will load the input with the value of the selected option.  Throughout this script section, string comparisons will need to be done in order to figure out which option was selected.  This seems to be the best way to do it according to everything I have seen oneline. ~Joe
    function updateCustomerSelection(inputCustomer) {
        var customerName = inputCustomer.value;

        var dataListOptions = document.getElementById("datalistCustomers").getElementsByTagName("option");
        var theSelectedOption = undefined;
        for (var i = 0; i < dataListOptions.length; i++) {
            if (dataListOptions[i].value == customerName) {
                theSelectedOption = dataListOptions[i];
            }
        }

        if (theSelectedOption != undefined) {
            var custId = theSelectedOption.dataset.custId;
            loadBillTo(custId);
            loadContacts(custId);
            document.getElementById("datalistShipTo").innerHTML = ""; //The ShipTo datalist needs to be cleared out before adding a new set of options to it
            loadShipTos(custId);
        }
        else {
            clearData();
        }
    }

    function loadBillTo(aCustId) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '@Model._apiAddress' + 'api/BillTo/GetBillToByCustId/' + aCustId, true);
        xhr.send();

        xhr.onload = function () {
            var billTo = JSON.parse(xhr.responseText);
            var textAreaBillTo = document.getElementById("textareaBillTo");
            if (xhr.status == 200) {
                textAreaBillTo.value = "";

                //Formatting the bill to text area text
                var billToText = billTo.Address1 + "\r\n";
                if (billTo.Address2 != "") { billToText += billTo.Address2 + "\r\n"; }
                if (billTo.Address3 != "") { billToText += billTo.Address3 + "\r\n"; }
                billToText += billTo.City + ", " + billTo.State + " " + billTo.Zip + " " + billTo.Country;
                if (billTo.PhoneNum != "") { billToText += "\r\nPhone: " + billTo.PhoneNum; }
                if (billTo.FaxNum != "") { billToText += "\r\nFax: " + billTo.FaxNum; }

                textAreaBillTo.value = billToText;
                textAreaBillTo.style.height = textAreaBillTo.scrollHeight + 3 + "px";
            }
        }
    }

    function loadContacts(aCustId) {
         var xhr = new XMLHttpRequest();
        xhr.open('GET', '@Model._apiAddress' + 'api/Contact/GetAllHydratedContactsByCust/' + aCustId, true);
        xhr.send();

        xhr.onload = function () {
            var contacts = JSON.parse(xhr.responseText);

            var datalistContacts = document.getElementById("datalistContact");
            if (contacts != null) {
                for (var i = 0; i < contacts.length; i++) {
                    var optionContact = document.createElement("option");
                    optionContact.innerHTML = contacts[i].PhoneNum;
                    optionContact.value = contacts[i].LastName + ", " + contacts[i].FirstName;
                    datalistContacts.appendChild(optionContact);
                }
            }

        }
    }

    function loadShipTos(aCustId) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '@Model._apiAddress' + 'api/ShipTo/GetShipTosByCust/' + aCustId, true);
        xhr.send();

        xhr.onload = function () {
            var shipTos = JSON.parse(xhr.responseText);
            _shipToModels = shipTos;

            var datalistShipTo = document.getElementById("datalistShipTo");
            if (shipTos != null) {
                for (var i = 0; i < shipTos.length; i++) {
                    var optionShipTo = document.createElement("option");
                    optionShipTo.value = shipTos[i].ShipToId + ". " + shipTos[i].Address1;
                    optionShipTo.innerHTML = shipTos[i].City + ", " + shipTos[i].State + " " + shipTos[i].Zip;
                    datalistShipTo.appendChild(optionShipTo);
                }
            }
            else {
                var blankOption = document.createElement("option");
                blankOption.value = "No Ship Tos";
                datalistShipTo.append(blankOption);
            }
        }
    }

    function loadParts(aCustId) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '@Model._apiAddress' + 'api/Part/GetPartsForCustId/' + aCustId, true);
        xhr.send();

        xhr.onload = function () {
            var parts = JSON.parse(xhr.responseText);
            _partModels = parts;

            
        }
    }

    function udpateShipToTextArea(shipToInput) {
        var shipToText = "";  //If the ship to in the input matches an option, this variable will be populated by the appropriate text.
        if (_shipToModels != undefined) {
            for (var i = 0; i < _shipToModels.length; i++) {
                if ((_shipToModels[i].ShipToId + ". " + _shipToModels[i].Address1) == shipToInput.value) {
                    shipToText = _shipToModels[i].Address1 + "\r\n";
                    if (_shipToModels[i].Address2 != "" && _shipToModels[i].Address2 != null) { shipToText += _shipToModels[i].Address2 + "\r\n"; }
                    if (_shipToModels[i].Address3 != "" && _shipToModels[i].Address3 != null) { shipToText += _shipToModels[i].Address3 + "\r\n"; }
                    shipToText += _shipToModels[i].City + ", " + _shipToModels[i].State + _shipToModels[i].Zip + _shipToModels[i].Country;
                    if (_shipToModels[i].EmailAddress != "" && _shipToModels[i].EmailAddress != null) { shipToText += "\r\nEmail: " + _shipToModels[i].EmailAddress; }
                    if (_shipToModels[i].PhoneNum != "" && shipToModels[i].PhoneNum != null) { shipToText += "\r\nPhone: " + _shipToModels[i].PhoneNum; }
                    if (_shipToModels[i].FaxNum != "" && _shipToModels[i].FaxNum != null) { shipToText += "\r\nFax: " + _shipToModels[i].FaxNum; }
                }
            }

            var textareaShipTo = document.getElementById("textareaShipTo");
            textareaShipTo.value = shipToText;
            textareaShipTo.style.height = textareaShipTo.scrollHeight + 3 + "px";
        }
    }

    function clearData() {
        document.getElementById("textareaBillTo").value = "";
        document.getElementById("inputContact").value = "";
        document.getElementById("datalistContact").innerHTML = "";
        document.getElementById("inputShipTo").value = "";
        document.getElementById("datalistShipTo").innerHTML = "";
        document.getElementById("textareaShipTo").value = "";
        _shipToModels = undefined;
    }
</script>